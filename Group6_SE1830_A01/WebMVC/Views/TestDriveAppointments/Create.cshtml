@model BLL.BusinessObjects.ViewCreateTestDriveAppointment
@{
    ViewBag.Title = "Tạo lịch hẹn lái thử";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="page-wrapper">
    <div class="left-column">
        <div class="form-container">
            <h2>+ Tạo lịch hẹn lái thử</h2>
            @if (!ViewData.ModelState.IsValid)
            {
                <div class="error-box">
                    <ul>
                        @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                        {
                            <li>@error.ErrorMessage</li>
                        }
                    </ul>
                </div>
            }

            <form method="post" onsubmit="return validateForm()">
                <div class="form-group">
                    <label for="CustomerId">Khách hàng</label>
                    <select asp-for="CreateTestDriveAppointment.CustomerId"
                            class="form-control"
                            asp-items="@(new SelectList(Model.Customers, "CustomerId", "FullName"))">
                    </select>
                </div>

                <!-- Hidden để lưu xe được chọn -->
                <input type="hidden" asp-for="CreateTestDriveAppointment.CarVersionId" />
                <input type="hidden" asp-for="CreateTestDriveAppointment.ColorId" />

                <div class="form-group">
                    <label for="DateTime">Ngày giờ</label>
                    <input asp-for="CreateTestDriveAppointment.DateTime"
                           type="datetime-local"
                           class="form-control" />
                </div>

                <div class="form-group">
                    <label for="Feedback">Ghi chú</label>
                    <textarea asp-for="CreateTestDriveAppointment.Feedback"
                              class="form-control"></textarea>
                </div>

                <button type="submit" class="btn-submit">Lưu lịch hẹn</button>
                <a href="/TestDriveAppointments/Index" class="btn-cancel">Hủy</a>
            </form>
        </div>
    </div>

    <div class="right-column">
        <div class="car-list">
            <h3>🚗 Xe có sẵn (chọn 1 xe)</h3>

            <div class="form-group">
                <input type="text" id="searchCar" class="form-control" placeholder="🔍 Tìm xe theo tên hoặc màu..." />
            </div>

            <table class="table-cars" id="carTable">
                <thead>
                    <tr>
                        <th>Chọn</th>
                        <th>Xe</th>
                        <th>Màu</th>
                        <th>Số lượng</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var car in Model.Inventory)
                    {
                        <tr>
                            <td><input type="radio" name="selectCar" value="@($"{car.VersionId}-{car.ColorId}")" /></td>
                            <td>@car.Version.VersionName - @car.Version.Model.ModelName</td>
                            <td>@car.Color.ColorName</td>
                            <td>@car.Quantity</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .page-wrapper {
        display: flex;
        gap: 20px;
        padding: 20px;
    }

    .left-column {
        flex: 1;
    }

    .right-column {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .form-container, .car-list {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .form-group {
        margin-bottom: 15px;
    }

    label {
        font-weight: 500;
        margin-bottom: 5px;
        display: block;
    }

    .form-control {
        width: 100%;
        padding: 8px;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
    }

    .btn-submit {
        background: #3b82f6;
        color: #fff;
        padding: 8px 14px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }

        .btn-submit:hover {
            background: #2563eb;
        }

    .btn-cancel {
        margin-left: 10px;
        text-decoration: none;
        padding: 8px 14px;
        border-radius: 6px;
        background: #e2e8f0;
        color: #1e293b;
    }

        .btn-cancel:hover {
            background: #cbd5e1;
        }

    .table-cars {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

        .table-cars th, .table-cars td {
            border-bottom: 1px solid #e2e8f0;
            padding: 6px;
            text-align: left;
        }

        .table-cars tr.selected {
            background: #dbeafe;
        }

    .error-box {
        background: #fee2e2;
        color: #b91c1c; 
        border: 1px solid #fca5a5; 
        padding: 10px 15px;
        border-radius: 6px;
        margin-bottom: 15px;
        font-size: 14px;
    }

        .error-box ul {
            margin: 0;
            padding-left: 20px;
        }

</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {

        const selectedCarVersion = document.querySelector("input[name='CreateTestDriveAppointment.CarVersionId']").value;
        const selectedColor = document.querySelector("input[name='CreateTestDriveAppointment.ColorId']").value;

        document.querySelectorAll("input[name='selectCar']").forEach(radio => {
            const [versionId, colorId] = radio.value.split("-");

            if(versionId === selectedCarVersion && colorId === selectedColor){
                radio.checked = true;
                radio.closest("tr").classList.add("selected");
            }

            radio.addEventListener("change", function () {
                const [carVersionId, colorId] = this.value.split("-");
                document.querySelector("input[name='CreateTestDriveAppointment.CarVersionId']").value = carVersionId;
                document.querySelector("input[name='CreateTestDriveAppointment.ColorId']").value = colorId;

                document.querySelectorAll("#carTable tbody tr").forEach(tr => tr.classList.remove("selected"));
                this.closest("tr").classList.add("selected");
            });
        });

        window.validateForm = function() {
            const selectedCar = document.querySelector("input[name='selectCar']:checked");
            const dateTime = document.getElementById("DateTime").value;

            if (!selectedCar) {
                alert("Vui lòng chọn xe trước khi lưu lịch hẹn!");
                return false;
            }

            if (!dateTime) {
                alert("Vui lòng chọn ngày giờ trước khi lưu lịch hẹn!");
                return false;
            }

            return true;
        };

        document.getElementById("searchCar").addEventListener("keyup", function () {
            const keyword = this.value.toLowerCase();
            document.querySelectorAll("#carTable tbody tr").forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(keyword) ? "" : "none";
            });
        });

    });
</script>
